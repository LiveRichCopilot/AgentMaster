#!/bin/bash
# Test all IAM permissions for JAi Cortex OS

PROJECT_ID="studio-2416451423-f2d96"
LOCATION="us-central1"

echo "ğŸ§ª Testing JAi Cortex OS Permissions"
echo "====================================="
echo ""

PASSED=0
FAILED=0

# Function to test permission
test_permission() {
    SERVICE=$1
    COMMAND=$2
    DESCRIPTION=$3
    
    echo "Testing: $DESCRIPTION"
    echo "  Command: $COMMAND"
    
    if eval "$COMMAND" > /dev/null 2>&1; then
        echo "  âœ… PASS"
        ((PASSED++))
    else
        echo "  âŒ FAIL - Missing permission for $SERVICE"
        ((FAILED++))
    fi
    echo ""
}

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  VERTEX AI PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "Vertex AI" \
    "gcloud ai models list --region=$LOCATION --project=$PROJECT_ID --limit=1" \
    "List Gemini models"

test_permission "Agent Engine" \
    "gcloud ai reasoning-engines list --region=$LOCATION --project=$PROJECT_ID --limit=1" \
    "List deployed agents"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  CLOUD STORAGE PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "Cloud Storage" \
    "gsutil ls gs://cortex_agent_staging" \
    "Access cortex_agent_staging bucket"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  FIRESTORE PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "Firestore" \
    "gcloud firestore databases list --project=$PROJECT_ID" \
    "Access Firestore databases"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  CLOUD TRACE PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "Cloud Trace" \
    "gcloud trace list --project=$PROJECT_ID --limit=1" \
    "List traces"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  BIGQUERY PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "BigQuery" \
    "bq ls --project_id=$PROJECT_ID --max_results=1" \
    "List BigQuery datasets"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "6ï¸âƒ£  CLOUD LOGGING PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "Cloud Logging" \
    "gcloud logging logs list --project=$PROJECT_ID --limit=1" \
    "List logs"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "7ï¸âƒ£  CLOUD MONITORING PERMISSIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

test_permission "Cloud Monitoring" \
    "gcloud monitoring channels list --project=$PROJECT_ID --limit=1" \
    "List monitoring channels"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š TEST RESULTS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… Passed: $PASSED"
echo "âŒ Failed: $FAILED"
echo ""

if [ $FAILED -eq 0 ]; then
    echo "ğŸ‰ ALL PERMISSIONS WORKING!"
    echo ""
    echo "You can now:"
    echo "  â€¢ Chat with JAi Cortex OS"
    echo "  â€¢ Call 24 specialist agents"
    echo "  â€¢ Upload files"
    echo "  â€¢ Save notes"
    echo "  â€¢ View traces"
    echo "  â€¢ Export to BigQuery"
    echo "  â€¢ Monitor performance"
else
    echo "âš ï¸  Some permissions missing."
    echo ""
    echo "Run this to grant missing permissions:"
    echo "  ./scripts/setup_all_iam_permissions.sh"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

